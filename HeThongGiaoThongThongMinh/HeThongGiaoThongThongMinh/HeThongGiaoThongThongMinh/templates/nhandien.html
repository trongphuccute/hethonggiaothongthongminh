<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Nh·∫≠n di·ªán bi·ªÉn b√°o giao th√¥ng</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body {
      background: linear-gradient(180deg, #f7f9fb, #eef2f6);
      font-family: 'Segoe UI', sans-serif;
      padding-top: 90px;
    }
    .title-bienbaocam {
      text-align: center;
      color: #2b3a67;
      font-weight: 700;
      margin-bottom: 20px;
    }
    .btn {
      border-radius: 25px;
      padding: 10px 25px;
      font-size: 1.1rem;
      font-weight: 500;
    }
    footer {
      text-align: center;
      color: gray;
      margin-top: 40px;
    }
    #cameraWrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-top: 30px;
    }
    #cameraStream {
      display: none;
      width: 400px;
      height: 400px;
      object-fit: contain;
      background-color: #f0f0f0;
      border-radius: 20px;
      border: 3px solid #007bff;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      transition: all 0.5s ease-in-out;
    }
    #closeCamBtn {
      display: none;
      margin-top: 15px;
      border-radius: 25px;
    }
    .result-section {
      text-align: center;
      margin-top: 30px;
    }
    .result-img, .result-stream-video {
      display: block;
      width: 400px;
      height: 400px;
      object-fit: contain;
      background-color: #f0f0f0;
      border-radius: 20px;
      border: 3px solid #28a745;
      margin: 0 auto;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      transition: all 0.5s ease-in-out;
    }
    .result-video {
      display: none; /* ·∫®n tag video */
      width: 400px;
      height: 400px;
      margin: 20px auto 0 auto;
      border-radius: 20px;
      border: 3px solid #28a745;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      background-color: #000;
      object-fit: contain;
    }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top bg-white shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold fs-4" href="{{ url_for('home') }}">HTNDBBGTTM</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse justify-content-end" id="navbarNavDropdown">
      <ul class="navbar-nav">
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">NH·∫¨N D·∫†NG</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="{{ url_for('nhandien') }}">Qu√©t Bi·ªÉn B√°o</a></li>
          </ul>
        </li>

        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">BI·ªÇN B√ÅO</a>
          <ul class="dropdown-menu">
            <li><a href="{{ url_for('bienbaocam') }}" class="dropdown-item">Bi·ªÉn B√°o C·∫•m</a></li>
            <li><a href="{{ url_for('bbnguyhiem') }}" class="dropdown-item">Bi·ªÉn B√°o Nguy Hi·ªÉm</a></li>
            <li><a href="{{ url_for('bbhieulenh') }}" class="dropdown-item">Bi·ªÉn B√°o Hi·ªáu L·ªánh</a></li>
            <li><a href="{{ url_for('bbchidan') }}" class="dropdown-item">Bi·ªÉn B√°o Ch·ªâ D·∫´n v√† bi·ªÉn b√°o ph·ª•</a></li>
            <li><a href="{{ url_for('vkd') }}" class="dropdown-item">V·∫°ch K·∫ª ƒê∆∞·ªùng</a></li>
          </ul>
        </li>

        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">TR·∫ÆC NGHI·ªÜM</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="{{ url_for('quizz') }}">Tr·∫Øc Nghi·ªám Xe M√°y C∆° B·∫£n</a></li>
            <li><a class="dropdown-item" href="{{ url_for('quizz2') }}">Tr·∫Øc Nghi·ªám Xe M√°y N√¢ng Cao</a></li>
            <li><a class="dropdown-item" href="{{ url_for('quizz3') }}">Tr·∫Øc Nghi·ªám √î T√¥ C∆° B·∫£n</a></li>
            <li><a class="dropdown-item" href="{{ url_for('quizz4') }}">Tr·∫Øc Nghi·ªám √î T√¥ N√¢ng Cao</a></li>
          </ul>
        </li>

        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">ƒêI·ªÄU LU·∫¨T & M·ª®C PH·∫†T</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="{{ url_for('dieuluat') }}">C√°c ƒêi·ªÅu Lu·∫≠t</a></li>
            <li><a class="dropdown-item" href="{{ url_for('mucphat') }}">M·ª©c Ph·∫°t Ph·ªï Bi·∫øn</a></li>
          </ul>
        </li>

       
      </ul> 
    </div>
  </div>
</nav>

 
  <!-- TI√äU ƒê·ªÄ -->
  <h1 class="title-bienbaocam">üöó H·ªÜ TH·ªêNG NH·∫¨N DI·ªÜN BI·ªÇN B√ÅO GIAO TH√îNG</h1>

  <!-- N√öT T·∫¢I -->
  <div class="text-center">
    <button id="openCamBtn" class="btn btn-primary btn-lg me-3">üì∑ M·ªü Camera</button>
    <button id="uploadImgBtn" class="btn btn-success btn-lg me-3">üñºÔ∏è T·∫£i ·∫¢nh L√™n</button>
    <button id="uploadVideoBtn" class="btn btn-warning btn-lg">üé• T·∫£i Video L√™n</button>
    <input type="file" id="fileInput" accept="image/*,video/*" style="display:none" />
  </div>

  <!-- CAMERA -->
  <div id="cameraWrapper">
    <img id="cameraStream" alt="Video s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y" />
    <button id="closeCamBtn" class="btn btn-danger btn-lg">‚ùå T·∫Øt Camera</button>
  </div>

  <!-- HI·ªÇN TH·ªä ·∫¢NH K·∫æT QU·∫¢ -->
  <div class="result-section" id="imageResultSection" style="display:none;">
    <h4>üîç K·∫øt qu·∫£ nh·∫≠n di·ªán ·∫£nh:</h4>
    <img id="resultImage" class="result-img" alt="·∫¢nh ƒë√£ t·∫£i l√™n" />
  </div>

  <!-- HI·ªÇN TH·ªä VIDEO STREAM K·∫æT QU·∫¢ T·ª™ SERVER -->
  <div class="result-section" id="streamVideoResultSection" style="display:none;">
    <h4>üîç K·∫øt qu·∫£ nh·∫≠n di·ªán video (stream):</h4>
    <img id="resultStreamVideo" class="result-stream-video" alt="Video stream nh·∫≠n di·ªán" />
  </div>

  <footer>
    <p>¬© 2025 - Nh√≥m H·ªá Th·ªëng Giao Th√¥ng Th√¥ng Minh</p>
  </footer>

  <script>
    // DOM
    const openCamBtn = document.getElementById("openCamBtn");
    const closeCamBtn = document.getElementById("closeCamBtn");
    const cameraStream = document.getElementById("cameraStream");
    const uploadImgBtn = document.getElementById("uploadImgBtn");
    const uploadVideoBtn = document.getElementById("uploadVideoBtn");
    const fileInput = document.getElementById("fileInput");
    const imageResultSection = document.getElementById("imageResultSection");
    const resultImage = document.getElementById("resultImage");
    const streamVideoResultSection = document.getElementById("streamVideoResultSection");
    const resultStreamVideo = document.getElementById("resultStreamVideo");

    // M·ªü camera
    openCamBtn.addEventListener("click", () => {
      cameraStream.src = "{{ url_for('video_feed') }}";
      cameraStream.style.display = "block";
      closeCamBtn.style.display = "inline-block";
      Swal.fire({ title: 'ƒêang b·∫≠t camera...', icon: 'info', timer: 1500, showConfirmButton: false });
    });

    // T·∫Øt camera
    closeCamBtn.addEventListener("click", () => {
      cameraStream.src = "";
      cameraStream.style.display = "none";
      closeCamBtn.style.display = "none";
      Swal.fire({ title: 'Camera ƒë√£ t·∫Øt', icon: 'success', timer: 1200, showConfirmButton: false });
    });

    // Upload ·∫£nh
    uploadImgBtn.addEventListener("click", () => {
      fileInput.accept = "image/*";
      fileInput.click();
    });

    // Upload video
    uploadVideoBtn.addEventListener("click", () => {
      fileInput.accept = "video/*";
      fileInput.click();
    });

    // Khi ch·ªçn file --> g·ª≠i l√™n server qua fetch
    fileInput.addEventListener("change", () => {
      const file = fileInput.files[0];
      if (!file) return;

      Swal.fire({ title: 'ƒêang x·ª≠ l√Ω file...', text: 'Vui l√≤ng ch·ªù trong gi√¢y l√°t', icon: 'info', showConfirmButton: false });

      const formData = new FormData();
      formData.append('image', file);

      // ƒê·∫∑t l·∫°i ·∫©n hi·ªÉn th·ªã c√°c k·∫øt qu·∫£ tr∆∞·ªõc khi show k·∫øt qu·∫£ m·ªõi
      imageResultSection.style.display = 'none';
      streamVideoResultSection.style.display = 'none';
      resultImage.src = '';
      resultStreamVideo.src = '';

      fetch("{{ url_for('upload_api') }}", {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        Swal.close();
        if (data.uploaded_image) {
          // Hi·ªÉn th·ªã ·∫£nh k·∫øt qu·∫£
          streamVideoResultSection.style.display = "none";
          imageResultSection.style.display = "block";
          resultImage.src = data.uploaded_image;
        } else if (data.stream_video_url) {
          // Hi·ªÉn th·ªã video stream realtime x·ª≠ l√Ω theo t·ª´ng frame
          imageResultSection.style.display = "none";
          streamVideoResultSection.style.display = "block";
          resultStreamVideo.src = data.stream_video_url;
        } else if (data.error) {
          Swal.fire('L·ªói', data.error, 'error');
        } else {
          Swal.fire('L·ªói', 'Ph·∫£n h·ªìi kh√¥ng h·ª£p l·ªá t·ª´ server', 'error');
        }
      })
      .catch(() => {
        Swal.close();
        Swal.fire('L·ªói', 'Upload ho·∫∑c x·ª≠ l√Ω th·∫•t b·∫°i', 'error');
      });
    });
  </script>
</body>
</html>
